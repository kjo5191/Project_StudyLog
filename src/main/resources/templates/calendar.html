<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì¼ì • ìº˜ë¦°ë”</title>
<link href="/css/styles.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />

<style>

	/* ì˜¤ëŠ˜ ë‚ ì§œ ìƒ‰ìƒ */
	.fc .fc-day-today {
		background-color: #f1f3f5 !important; /* Bootstrapì˜ gray-100 ëŠë‚Œ */
	}

	/* ìš”ì¼ í—¤ë” í…ìŠ¤íŠ¸ */
	.fc .fc-col-header-cell-cushion {
		color: #343a40;
		font-weight: 500;
	}

	/* ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ */
	.fc .fc-button-primary {
		background-color: #343a40;
		border-color: #343a40;
	}
	.fc .fc-button-primary:hover {
		background-color: #212529;
		border-color: #212529;
	}

	/* íˆ´ë°” í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
	.fc .fc-toolbar-title {
		color: #212529;
	}

	/* ì¼ì • í•­ëª© hover íš¨ê³¼ */
	.fc-event:hover {
		background-color: #212529 !important;
		cursor: pointer;
	}

	/* ë‚ ì§œ ìˆ«ì ìƒ‰ìƒ ë³€ê²½ (ê¸°ë³¸ì ìœ¼ë¡œ a íƒœê·¸ë¡œ ë˜ì–´ ìˆìŒ) */
	.fc .fc-daygrid-day-number {
		color: #212529 !important;
		text-decoration: none;
	}

	/* íƒ€ì„ë¼ì¸ ë·°(ì˜ˆ: timeGrid)ì—ì„œ ì‹œê°„ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
	.fc .fc-timegrid-slot-label {
		color: #212529 !important; /* Bootstrapì˜ text-dark */
	}

	/* ì¼ì • ì‹œê°„ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì¼ê´„ í†µì¼ */
	.fc .fc-event-time {
		color: #ffffff !important;
	}
	
	/* ì¼ì • í…ìŠ¤íŠ¸ ìƒ‰ìƒ (event title) */
	.fc .fc-event-title {
		color: #ffffff !important;
		font-weight: 500;
	}

	/* ì¼ì • ë°°ê²½ ìƒ‰ìƒ */
	.fc .fc-event {
		background-color: #343a40be !important;
		border: none !important;
	}

	/* hover ì‹œ ì¼ì • ê°•ì¡° */
	.fc-event:hover {
		background-color: #212529 !important;
		cursor: pointer;
	}
	
	/* ì¼ì • ì•ì— ìë™ ìƒì„±ë˜ëŠ” ë„íŠ¸ ì•„ì´ì½˜ ì œê±° (ì‘ë™ì•ˆí•¨;;)*/
	.fc .fc-event .fc-event-time .fc-icon-dot {
		display: none !important;
	}
	
	.fc .fc-event-time {
		font-weight: 500 !important;
	}

	/* ì¼ì • ê°„ ê°„ê²© ë„ìš°ê¸° */
	.fc-daygrid-event {
		margin-bottom: 4px; /* ìˆ«ìëŠ” ì ë‹¹íˆ ì¡°ì ˆ ê°€ëŠ¥ */
	}

	/* ì¼ì • 3ì¢…ë¥˜ */
	.fc-event.one-day-event {
		background-color: #343a40 !important;
		color: #fff !important;
	}

	.fc-event.multi-day-event {
		background-color: #6c757d !important;
		color: #fff !important;
	}

	.fc-event.job-event {
		background-color: #198754 !important;
		color: #fff !important;
	}

</style>
</head>

<body>
	<!-- ìƒë‹¨ ë°” -->
	<div th:replace="fragments/navbar :: navbar"></div>

	<div class="container mt-5" style="max-width: 1000px;">
	<div class="container mt-5">
		<h3 class="mb-4 text-center fw-semibold">Calendar</h3>
		<div id="calendar"></div>
	</div>

	<!-- <div class="container mt-4">
		<h3 class="mb-4 text-center">Calendar</h3>
		<div id="calendar"></div>
	</div> -->

	<!-- ì¼ì • ë“±ë¡ ëª¨ë‹¬ -->
	<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="text-dark" id="scheduleModalLabel">ì¼ì • ë“±ë¡</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="scheduleForm">
						<div class="mb-3">
							<label for="title" class="form-label">ì œëª©</label>
							<input type="text" class="form-control" id="title" required />
						</div>
						<div class="mb-3">
							<label for="content" class="form-label">ë‚´ìš©</label>
							<textarea class="form-control" id="content" rows="3"></textarea>
						</div>
						<div class="form-check mb-3">
							<input class="form-check-input" type="checkbox" id="allDayCheckbox" />
							<label class="form-check-label" for="allDayCheckbox">í•˜ë£¨ ì¢…ì¼</label>
						</div>
						<div class="mb-3">
							<label for="startDate" class="form-label">ì‹œì‘ì¼ì‹œ</label>
							<input type="datetime-local" class="form-control" id="startDate" required />
						</div>
						<div class="mb-3">
							<label for="endDate" class="form-label">ì¢…ë£Œì¼ì‹œ (ì„ íƒ)</label>
							<input type="datetime-local" class="form-control" id="endDate" />
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
					<button type="button" class="btn btn-dark" onclick="submitSchedule()">ë“±ë¡</button>
				</div>
			</div>
		</div>
	</div>

	<!-- ì¼ì • ìƒì„¸ ëª¨ë‹¬ -->
	<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<input type="hidden" id="detailId" />
				<div class="modal-header">
					<h5 class="text-dark" id="detailModalLabel">ì¼ì • ìƒì„¸</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p><strong>ì œëª©:</strong> <span id="detailTitle"></span></p>
					<p><strong>ë‚´ìš©:</strong> <span id="detailContent"></span></p>
					<p><strong>ì‹œì‘ì¼:</strong> <span id="detailStart"></span></p>
					<p><strong>ì¢…ë£Œì¼:</strong> <span id="detailEnd"></span></p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
					<button type="button" class="btn btn-dark" onclick="openEditModal()">ìˆ˜ì •</button>
					<button type="button" class="btn btn-dark" onclick="deleteSchedule()">ì‚­ì œ</button>
				</div>
			</div>
		</div>
	</div>

	<!-- ìˆ˜ì • ëª¨ë‹¬ -->
	<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<input type="hidden" id="editId" />
				<div class="modal-header">
					<h5 class="text-dark" id="editModalLabel">ì¼ì • ìˆ˜ì •</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label for="editTitle" class="form-label">ì œëª©</label>
						<input type="text" class="form-control" id="editTitle" />
					</div>
					<div class="mb-3">
						<label for="editContent" class="form-label">ë‚´ìš©</label>
						<textarea class="form-control" id="editContent" rows="3"></textarea>
					</div>
					<div class="form-check mb-3">
						<input class="form-check-input" type="checkbox" id="editAllDayCheckbox" />
						<label class="form-check-label" for="editAllDayCheckbox">í•˜ë£¨ ì¢…ì¼</label>
					</div>
					<div class="mb-3">
						<label for="editStart" class="form-label">ì‹œì‘ì¼ì‹œ</label>
						<input type="datetime-local" class="form-control" id="editStart" />
					</div>
					<div class="mb-3">
						<label for="editEnd" class="form-label">ì¢…ë£Œì¼ì‹œ</label>
						<input type="datetime-local" class="form-control" id="editEnd" />
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
					<button type="button" class="btn btn-outline-dark" onclick="submitEdit()">ì €ì¥</button>
				</div>
			</div>
		</div>
	</div>

	<!-- í•˜ë‹¨ ë°” -->
	<div th:replace="fragments/footer :: footer"></div>	

	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		
	document.addEventListener('DOMContentLoaded', function () {
		const calendarEl = document.getElementById('calendar');

		const calendar = new FullCalendar.Calendar(calendarEl, {
			initialView: 'dayGridMonth',
			themeSystem: 'bootstrap5',
			locale: 'ko',
			// ì¼ì • ì—°ë™
			// /api/schedule â†’ ê¸°ì¡´ ê°œì¸ ì¼ì •
			// /api/job-events â†’ JobApplicationì—ì„œ ì¶”ì¶œí•œ ì§€ì›ì¼ì •ë“¤
			// extendedProps.type === 'job' ì¡°ê±´ìœ¼ë¡œ ì¼ë°˜ ì¼ì •ê³¼ êµ¬ë¶„ ê°€ëŠ¥
			// í´ë¦­ ì‹œ jobì¼ì •ì´ë©´ /job/edit/{id}ë¡œ ì´ë™ ê°€ëŠ¥			
			eventSources: [
				{
					url: '/api/schedule', // ê¸°ì¡´ ì¼ë°˜ ì¼ì •
					color: '#343a40',      // ì§„íšŒìƒ‰
					textColor: '#ffffff'
				},
				{
					url: '/job/calendar', // JobApplication ê¸°ë°˜ ì¼ì •
					color: '#198754',       // Bootstrap success ìƒ‰ìƒ
					textColor: '#ffffff'
				}
			],		
			// events: '/api/schedule',
	
			dateClick: function (info) {
				document.getElementById('startDate').value = info.dateStr + 'T09:00';
				document.getElementById('endDate').value = "";
				document.getElementById('scheduleModalLabel').textContent = formatDateLabel(info.dateStr);
				new bootstrap.Modal(document.getElementById('scheduleModal')).show();
			},
			// ì¼ì • í´ë¦­ ì‹œ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
			eventClick: function(info) {
				const event = info.event;
				const isJob = event.extendedProps.type === 'job';

				if (isJob) {
					alert(`[${event.title}] í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.`);
					location.href = `/job/edit/${event.extendedProps.jobId}`;
					return;
				}

				document.getElementById('detailId').value = event.id;
				document.getElementById('detailTitle').textContent = event.title;
				document.getElementById('detailContent').textContent = event.extendedProps.content || '-';
				document.getElementById('detailStart').dataset.allDay = event.allDay;

				const start = event.start;
				const end = event.end;

				// í‘œì‹œìš© ë¬¸ìì—´ (ì˜ˆ: 2025. 5. 27. ì˜¤ì „ 09:00)
				const formatDateTime = (date) => {
					return date ? date.toLocaleString('ko-KR', {
						year: 'numeric',
						month: 'long',
						day: 'numeric',
						hour: '2-digit',
						minute: '2-digit',
						hour12: true
					}) : '-';
				};

				// hidden dataset ìš©ìœ¼ë¡œ ISO string ì €ì¥ (ìˆ˜ì • ì‹œ ì‚¬ìš©)
				document.getElementById('detailStart').textContent = formatDateTime(start);
				document.getElementById('detailStart').dataset.value = start ? start.toISOString() : '';
				document.getElementById('detailEnd').textContent = formatDateTime(end);
				document.getElementById('detailEnd').dataset.value = end ? end.toISOString() : '';

				const modal = new bootstrap.Modal(document.getElementById('detailModal'));
				modal.show();
			},

			eventClassNames: function(arg) {
				if (arg.event.extendedProps.type === 'job') {
					return ['job-event'];
				}
				if (!arg.event.end) {
					return ['one-day-event'];
				}
				return ['multi-day-event'];
			}			
		});
		calendar.render();
	});

	function formatDateLabel(dateStr) {
		const date = new Date(dateStr);
		return `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼ ì¼ì • ë“±ë¡`;
	}

	function formatDateInput(isoString) {
		if (!isoString || isoString === "-") return "";

		const date = new Date(isoString);
		const offset = date.getTimezoneOffset(); // ë¶„ ë‹¨ìœ„
		const localDate = new Date(date.getTime() - offset * 60 * 1000);

		return localDate.toISOString().slice(0, 16); // YYYY-MM-DDTHH:mm
	}

	function submitSchedule() {
		const title = document.getElementById('title').value;
		const content = document.getElementById('content').value;
		const allDay = document.getElementById('allDayCheckbox').checked;
		const startRaw = document.getElementById('startDate').value;
		const endRaw = document.getElementById('endDate').value;

		let start = startRaw;
		let end = endRaw || startRaw;

		// if (allDay) {
		// 	// datetime-local â†’ date-only ë¡œ ì „í™˜
		// 	start = startRaw.split('T')[0];
		// 	end = endRaw ? endRaw.split('T')[0] : start;
		// }
		if (allDay) {
			const dateOnly = startRaw.split('T')[0]; // "2025-06-12"
			start = dateOnly + "T00:00:00";
			end = dateOnly + "T23:59:59";
		}

		const data = {
			title,
			content,
			start,
			end,
			allDay,
			done: false
		};

		fetch("/api/schedule", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify(data)
		}).then(res => {
			if (res.ok) {
				alert("ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
				location.reload();
			} else alert("ë“±ë¡ ì‹¤íŒ¨!");
		});
	}

	// ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
	function openEditModal() {
		document.getElementById('editId').value = document.getElementById('detailId').value;
		document.getElementById('editTitle').value = document.getElementById('detailTitle').textContent;
		document.getElementById('editContent').value = document.getElementById('detailContent').textContent;

		const startIso = document.getElementById('detailStart').dataset.value;
		const endIso = document.getElementById('detailEnd').dataset.value;

		// ğŸ’¡ allDay ì—¬ë¶€ë„ ì €ì¥ë˜ì–´ì•¼ í•˜ë¯€ë¡œ í•´ë‹¹ ê°’ ì½ê¸°
		const isAllDay = document.getElementById('detailStart').dataset.allDay === 'true';
		document.getElementById('editAllDayCheckbox').checked = isAllDay;		

		document.getElementById('editStart').value = formatDateInput(startIso);
		document.getElementById('editEnd').value = formatDateInput(endIso);

		const modal = new bootstrap.Modal(document.getElementById('editModal'));
		modal.show();
	}

	function submitEdit() {
		const id = document.getElementById('editId').value;
		const title = document.getElementById('editTitle').value;
		const content = document.getElementById('editContent').value;
		const allDay = document.getElementById('editAllDayCheckbox').checked;

		const startInput = document.getElementById('editStart').value;
		const endInput = document.getElementById('editEnd').value;

		let start = startInput;
		let end = endInput || startInput;

		if (allDay) {
			const dateOnly = startInput.split('T')[0];
			start = dateOnly + "T00:00:00";
			end = dateOnly + "T23:59:59";
		}

		const data = {
			id,
			title,
			content,
			start,
			end,
			allDay,
			done: false
		};

		fetch("/api/schedule/" + id, {
			method: "PUT",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify(data)
		}).then(res => {
			if (res.ok) {
				alert("ìˆ˜ì • ì™„ë£Œ!");
				location.reload();
			} else alert("ìˆ˜ì • ì‹¤íŒ¨!");
		});
	}


	function deleteSchedule() {
		const id = document.getElementById('detailId').value;

		if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

		fetch("/api/schedule/" + id, {
			method: "DELETE"
		}).then(res => {
			if (res.ok) {
				alert("ì‚­ì œ ì™„ë£Œ!");
				location.reload();
			} else {
				alert("ì‚­ì œ ì‹¤íŒ¨!");
			}
		});
	}

</script>
</body>
</html>
